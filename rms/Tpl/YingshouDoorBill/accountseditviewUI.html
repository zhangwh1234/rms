<style>
    .accountsTableHeader {
        background-color: #008B00;
        font-size: 12px;
    }

    #accountsTable td {
        height: 25px;
    }

    #accountsTable span {
        font-size: 16px;
    }

    #accountsTable input {
        font-size: 16px;
    }

</style>
<table id="YingshouDoorBillAccountsTable" style="BORDER-COLLAPSE: collapse" borderColor="#CCCCCC" cellSpacing="0" width="100%" align="center" border="1">
    <tr class="accountsTableHeader">
        <td width="5%" align="center" class="accountsTableHeaderLeftTd">序号</td>
        <td width="10%" align="center" class="accountsTableHeaderLeftTd">编号</td>
        <td width="30%" align="center" class="accountsTableHeaderLeftTd">名称</td>
        <td width="15%" align="center" class="accountsTableHeaderLeftTd">金额</td>
        <td width="25%" align="center" class="accountsTableHeaderLeftTd">备注</td>
        <td width="10%" align="center" class="accountsTableHeaderRightTd">操作</td>
    </tr>
    <empty name="doorbillaccounts">
        <for start="0" end="3" name="key">
            <tr>
                <td width="5%" align="center">{$key+1}</td>
                <td width="10%" align="center"> {//代码}
                    <input id="YingshouDoorBillAccountsCode_{$key+1}" name="accountsCode_{$key+1}" type="text" size="6" tabindex="1" onkeydown="YingshouDoorBillAccountsEditViewModule.getAccountsByCode({$key+1},event,this);"
                        AUTOCOMPLETE="off" style="font-size:16px;" />

                    <img id="YingshouDoorBillsearchIcon1" title="选择" src="./__PUBLIC__/Images/products.gif" style="cursor: pointer;" align="absmiddle" onclick="YingshouDoorBillAccountsEditViewModule.accountsPickList('__URL__/popupAccountsview/module/Accounts/row/{$key+1}');" /><a
                        href="javascript:YingshouDoorBillAccountsEditViewModule.accountsPickList('__URL__/popupAccountsview/module/Accounts/row/{$key+1}')">选择</a>
                </td>
                <td width="30%" align="center"> {//客户名称}
                    <input id="YingshouDoorBillAccountsName_{$key+1}" name="accountsName_{$key+1}" type="text" size="30" readonly="readonly" style="font-size:16px;" />
                </td>
                <td width="15%" align="center"> {//金额}
                    <input id="YingshouDoorBillAccountsMoney_{$key+1}" name="accountsMoney_{$key+1}" type="text" size="10" onkeydown="YingshouDoorBillAccountsEditViewModule.keydownSumAccountsMoney('{$key+1}',event,this);"
                        onblur="YingshouDoorBillAccountsEditViewModule.blurSumAccountsMoney();" tabindex="1" value="" style="font-size:16px;" />
                </td>
                <td width="25%" align="center"> {//备注}
                    <input id="YingshouDoorBillAccountsNote_{$key+1}" name="accountsNote_{$key+1}" type="text" size="30" onkeydown="YingshouDoorBillAccountsEditViewModule.keydownAccountsNote('{$key+2}',event);"
                        style="font-size:16px;" />
                </td>
                <td width="10%" align="center"><a href="#" onclick="YingshouDoorBillAccountsEditViewModule.clearAccounts({$key+1});">清空</a>
                </td>
            </tr>
        </for>
    </empty>
    <foreach name="doorbillaccounts" item="vo">
        <tr>
            <td width="5%" align="center">{$key+1}</td>
            <td width="10%" align="center"> {//产品代码}
                <input id="YingshouDoorBillAccountsCode_{$key+1}" name="accountsCode_{$key+1}" type="text" size="6" tabindex="1" value="{$vo.code}" onkeydown="YingshouDoorBillAccountsEditViewModule.getAccountsByCode({$key+1},event,this);"
                    AUTOCOMPLETE="off" style="font-size:16px;" />
                <img id="YingshouDoorBillAccountssearchIcon1" title="客户选择" src="./__PUBLIC__/Images/products.gif" style="cursor: pointer;" align="absmiddle" onclick="YingshouDoorBillAccountsEditViewModule.accountsPickList('__URL__/popupAccountsview/module/Accounts/row/{$key+1}');" /><a
                    href="javascript:YingshouDoorBillAccountsEditViewModule.accountsPickList('__URL__/popupAccountsview/module/Accounts/row/{$key+1}')">选择</a>
            </td>
            <td width="30%" align="center"> {//产品名称}
                <input id="YingshouDoorBillAccountsName_{$key+1}" name="accountsName_{$key+1}" type="text" size="30" readonly="readonly" value="{$vo.name}" style="font-size:16px;" />
            </td>
            <td width="15%" align="center"> {//金额}
                <input id="YingshouDoorBillAccountsMoney_{$key+1}" name="accountsMoney_{$key+1}" type="text" size="10" onkeydown="YingshouDoorBillAccountsEditViewModule.keydownSumAccountsMoney();"
                    onblur="YingshouDoorBillAccountsEditViewModule.blurSumAccountsMoney();" tabindex="1" value="{$vo.money}" style="font-size:16px;" />
            </td>
            <td width="25%" align="center"> {//备注}
                <input id="YingshouDoorBillAccountsNote_{$key+1}" name="accountsNote_{$key+1}" type="text" size="30" value="{$vo.note}" style="font-size:16px;" />
            </td>
            <td width="10%" align="center"><a href="#" onclick="YingshouDoorBillAccountsEditViewModule.clearAccounts('{$key+1}');">清空</a>
            </td>
        </tr>
    </foreach>
</table>
<table width="100%" style="BORDER-COLLAPSE: collapse" borderColor="#CCCCCC" cellSpacing="0" width="100%" align="center" border="1">
    <tr>
        <td class="accountsTableXiaojiLeftTd" width="65%">
            <a href="#" class="easyui-linkbutton" data-options="iconCls:'icons-car_cart_basket-basket_add'" onclick="YingshouDoorBillAccountsEditViewModule.addAccounts();" style="font-size:16px;">添加项目</a>
            <a href="#" class="easyui-linkbutton" data-options="iconCls:'icons-car_cart_basket-basket_delete'" onclick="YingshouDoorBillAccountsEditViewModule.delAccounts();" style="font-size:16px;margin-left:30px;">删除项目最后一行</a>
            <input id="YingshouDoorBillAccountsLength" name="accountsLength" type="hidden" value="{$key+1}" />
        </td>

        <td style="font-size: 16px;">

        </td>
        <td class="accoutsTableXiaojiRightTd" style="font-size: 14px;"> {// 金额小计}
            <span>小计</span>
            <input id="YingshouDoorBillAccountsTotalMoney" name="accountsTotalMoney" type="text" size="10" readonly="readonly" style="border: 0px;font-size: 14px;" value="{$info.note}" />
        </td>
    </tr>
</table>

<script type="text/javascript">
    var YingshouDoorBillAccountsEditViewModule = {

        init: function () {},

        test: function () {
            alert('ok');
        },

        //添加产品
        addAccounts: function () {
            //取得表格行的长度
            var rowNum = $("#YingshouDoorBillAccountsTable tr").length;

            var tableTrAppend = "<tr> ";
            tableTrAppend += "<td width='5%' align='center' class='accountsTableLeftTd'>" + rowNum + "</td> ";
            tableTrAppend += "<td width='15%' align='center' class='accountsTableLeftTd'>";
            tableTrAppend += "<input class='easyui-numberbox' id='YingshouDoorBillAccountsCode_" + rowNum + "' name='accountsCode_" + rowNum +
                "'  type='text' size='6' tabindex='1' onkeyup='YingshouDoorBillAccountsEditViewModule.getAccountsByCode(" + rowNum + ",event,this)' style='font-size:16px;' />";
            tableTrAppend += "<img id='YingshouDoorBillsearchIcon1' title='客户选择' src='./" + PUBLIC +
                "/Images/products.gif' style='cursor: pointer;' align='absmiddle' onclick='YingshouDoorBillAccountsEditViewModule.accountsPickList(\"__URL__/popupAccountsview/module/Accounts/row/" +
                rowNum + "\");' />";
            tableTrAppend += "<a href='javascript:YingshouDoorBillAccountsEditViewModule.accountsPickList(\"__URL__/popupAccountsview/module/Accounts/row/" + rowNum + "\");' >选择</a>";
            tableTrAppend += "</td>";
            tableTrAppend += "<td width='30%' align='center' class='accountsTableLeftTd'>";
            tableTrAppend += "<input id='YingshouDoorBillAccountsName_" + rowNum + "' name='accountsName_" + rowNum + "' type='text' size='30'  style='font-size:16px;' readonly />";
            tableTrAppend += "</td>";
            tableTrAppend += "<td width='15%' align='center' class='accountsTableLeftTd'>";
            tableTrAppend += "<input id='YingshouDoorBillAccountsMoney_" + rowNum + "' name='accountsMoney_" + rowNum +
                "' type='text' size='10'   tabindex='1' value='' style='font-size:16px;' onkeydown=\"YingshouDoorBillAccountsEditViewModule.keydownSumAccountsMoney();\"\n" +
                "                       onblur=\"YingshouDoorBillAccountsEditViewModule.blurSumAccountsMoney();\" />";
            tableTrAppend += "</td>";
            tableTrAppend += "<td width='25%' align='center' class='accountsTableLeftTd'>";
            tableTrAppend += "<input id='YingshouDoorBillAccountsNote_" + rowNum + "' name='accountsNote_" + rowNum + "' type='text' size='30'  style='font-size:16px;'  />";
            tableTrAppend += "</td>";
            tableTrAppend += "<td width='10%' align='center' class='accountsTableLeftTd'><a href='#' onclick='YingshouDoorBillAccountsEditViewModule.clearAccounts(" + rowNum +
                ");' >清空</a></td>";
            tableTrAppend += "</tr>";
            $("#YingshouDoorBillAccountsTable").append(tableTrAppend);
            $("#YingshouDoorBillAccountsLength").attr("value", rowNum + 1); //表格行数保存
        },

        /* 键盘回车计算产品金额 */
        keydownSumAccountsMoney: function (rowNum, evt, obj) {
            evt = evt ? evt : ((window.event) ? window.event : null);
            var key = evt.keyCode ? evt.keyCode : evt.which;
            if (key == 13) {
                if ($("#YingshouDoorBillAccountsName_" + rowNum).val() != '') { //如果不为空，才计算
                    this.sumAccountsMoney(rowNum);
                }
                $("#YingshouDoorBillAccountsNote_" + rowNum).focus();
            }
            //向上移动一个
            if (key == 38) {
                var focusNum = rowNum - 1;
                if (focusNum > 0) {
                    $("#YingshouDoorBillAccountsCode_" + focusNum).focus();
                }
            }
            //向下移动
            if (key == 40) {
                $("#YingshouDoorBillAccountsCode_" + rowNum).focus();
            }
        },

        /**
         * 备注的键盘回车处理
         */
        keydownAccountsNote: function (rowNum, evt) {
            evt = evt ? evt : ((window.event) ? window.event : null);
            var key = evt.keyCode ? evt.keyCode : evt.which;
            if (key == 13) {
                $("#YingshouDoorBillAccountsCode_" + rowNum).focus();
            }
        },

        //产品数量输入框失去焦点
        blurkeydownSumProductsMoney: function (rowNum, obj) {
            this.sumProductsMoney(rowNum);
        },

        /* 通过产品代码取得产品 */
        // rowNum 是行号，evt是firefox下的event事件，obj是this指针
        getAccountsByCode: function (rowNum, evt, obj) {
            evt = evt ? evt : ((window.event) ? window.event : null);
            var key = evt.keyCode ? evt.keyCode : evt.which;
            var code = $(obj).val();

            if ((key == 13) && (code.length > 0)) {
                this.getAccounts(rowNum, code);
            }
            //向上移动
            if (key == 38) {
                $("#YingshouDoorBillAccountsCode_" + rowNum).focus();
            }
            //向下移动
            if (key == 40) {
                var focusNum = rowNum + 1;
                $("#YingshouDoorBillAccountsCode_" + focusNum).focus();
            }

        },

        /* 弹出窗口，选择产品 */
        //moduleName:产品名称  rowNum:行号 moduleName,rowNum
        accountsPickList: function (url) {
            //url = url + '/returnModule/' + '{$moduleName}{$Think.ACTION_NAME|ucfirst}';
            $('#globel-dialog-div').dialog({
                title: '选择客户',
                iconCls: 'icons-application-application_add',
                width: 900,
                height: 540,
                cache: false,
                href: url,
                modal: true,
                collapsible: false,
                minimizable: false,
                resizable: false,
                maximizable: false,
                buttons: [{
                    text: '确定',
                    iconCls: 'icons-other-tick',
                    handler: function () {
                        $(that.dialog).find('form').eq(0).form('submit', {
                            onSubmit: function () {
                                var isValid = $(this).form('validate');
                                if (!isValid) return false;

                                var formArray = $(this).serializeArray();
                                var url = '__URL__/searchviewAddress/';
                                $.each(formArray, function (key, value) {
                                    url = url + value.name + '/' + value.value;
                                })
                                IndexIndexModule.openOperateTab(url, '订单地址查询');
                                $(that.dialog).dialog('close');
                                return false;
                            }
                        });
                    }
                }, {
                    text: '取消',
                    iconCls: 'icons-arrow-cross',
                    handler: function () {
                        $('#globel-dialog-div').dialog('close');
                    }
                }]
            });

        },

        /* 清空产品上的内容 */
        clearAccounts: function (rowNum) {
            var accountsCode = $("#YingshouDoorBillAccountsCode_" + rowNum).val();
            var accountsName = $("#YingshouDoorBillAccountsName_" + rowNum).val();

            if ((accountsCode == '') && (accountsName == '')) {
                return;
            }
            if (confirm("是否要清空内容")) {
                $("#YingshouDoorBillAccountsCode_" + rowNum).val('');
                $("#YingshouDoorBillAccountsName_" + rowNum).val('');
                $("#YingshouDoorBillAccountsMoney_" + rowNum).val('');
                $("#YingshouDoorBillAccountsNote_" + rowNum).val('');
                this.sumAccountsMoney(rowNum);
            }
        },

        /*  删除客户最后一行 */
        delAccounts: function () {
            //取得表格行的长度
            var rowNum = $("#YingshouDoorBillAccountsTable tr").length;
            if (rowNum == 2) {
                alert("最后一行不能删除");
                return;
            }
            $("#YingshouDoorBillAccountsTable tr:last").remove();
            $("#YingshouDoorBillAccountsLength").attr("value", rowNum - 1); //表格行数保存
            this.sumAccountsMoney(rowNum);

        },


        //根据用户输入的客户代码，输出产品名称
        getAccounts: function (rowNum, code) {
            var that = this;
            $.ajax({
                url: "__URL__/getAccountsByCode&code=" + code,
                async: true,
                beforeSend: function () {},
                success: function (mydata) {
                    var accountsName = '';
                    if (mydata) {
                        //首先检查父窗口表格是否有存在输入的代码和产品
                        var rowLength = $("#accountsTable tr").length;
                        for (i = 1; i < rowLength; i++) {
                            accountsName = $("YingshouDoorBillAccountsName_" + i).val();
                            if ((accountsName == mydata.name) && (i != rowNum)) {
                                alert('客户已经存在,不能添加！');
                                return;
                            }
                        }
                        $("#YingshouDoorBillAccountsName_" + rowNum).val(mydata.name);
                        //跳转到下一行
                        $("#YingshouDoorBillAccountsMoney_" + rowNum).focus();
                    } else {
                        alert("输入的客户代码有错误，请重新输入！");
                        return;
                    }
                }

            })
        },


        /* 计算产品金额 */
        sumAccountsMoney: function (rowNum) {

            //计算全部的金额
            var totalMoney = 0;
            //取得表格行的长度
            var rowLength = $("#YingshouDoorBillAccountsTable tr").length;
            for (i = 1; i < rowLength; i++) {
                if ($("#YingshouDoorBillAccountsMoney_" + i).val() > 0) {
                    totalMoney = totalMoney + parseFloat($("#YingshouDoorBillAccountsMoney_" + i).val());
                }
            }
            $("#YingshouDoorBillAccountsTotalMoney").val(totalMoney); //小计


            //写入总的金额
            totalMoney = totalMoney.toFixed(2);

            $('#YingshouDoorBillCreateviewForm input[name=money]').val(totalMoney);
            $('#YingshouDoorBillEditviewForm input[name=money]').val(totalMoney);

        },


        //产品代码失去焦点的计算金额
        blurSumAccountsMoney: function (rowNum, obj) {
            if ($("#YingshouDoorBillAccountsName_" + rowNum).val() != '') { //如果不为空，才计算
                this.sumAccountsMoney(rowNum);
            }
        },


        //判断是否为数字
        IsNum: function (s) {
            if (s != null && s != "") {
                return !isNaN(s);
            }
            return false;
        }

    }

    /*产品的js计算程序*/
    var accountsAjax = false; //判断是否查询过产品代码，防止在ajax中按回车，反复执行，有个alert的小bug
</script>