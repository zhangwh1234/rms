<style>
    .moduleOperatert {
        clear: both;
        margin: 0px;
        padding: 0px;
        overflow: scroll;
    }

</style>
<div class="moduleMenu">
    <ul>
        <li>{$Think.lang.$navName}</li>
        <li><a href="javascript:void(0);" class="moduleName" onclick="IndexIndexModule.updateOperateTab('__URL__/listview');">&nbsp;&gt;{$Think.lang.$moduleName}</a>
        </li>
        <li>&nbsp;&gt;新建操作</li>
        <li style="width: 50px;">&nbsp;</li>

        <li style="margin-left: 10px;"><a href="javascript:;" onclick="OrderFormCreateviewModule.insert();"><img src=".__PUBLIC__/Images/newBtn.png" alt="" title="" border="0"></a></li>
        <li><a href="javascript:void(0);" onclick="OrderFormCreateviewModule.insert();">保存订单<span>^9</span></a></li>

        <li style="margin-left: 30px;"><a href="javascript:;" onclick="IndexIndexModule.updateOperateTab('__URL__/{$returnAction}');"><img src=".__PUBLIC__/Images/newBtn.png" alt="" title="" border="0"></a></li>
        <li><a href="javascript:void(0);" onclick="IndexIndexModule.updateOperateTab('__URL__/{$returnAction}');">放弃,返回列表<span>^4</span></a>
        </li>


        <li style="margin-left: 30px;"><a href="javascript:;" onclick="OrderFormCreateviewModule.showTodayMenuview();"><img src=".__PUBLIC__/Images/newBtn.png" alt="" title="" border="0"></a></li>
        <li><a href="javascript:void(0);" onclick="OrderFormCreateviewModule.showTodayMenuview();">查看今日菜单<span>^0</span></a></li>


        <li style="float: right;margin-right: 60px;"><a href="#" onclick="IndexIndexModule.closeOperateTab();">关闭</a>
        </li>
        <li style="float:right;"><a href="javascript:;" onclick="IndexIndexModule.closeOperateTab();"><img src=".__PUBLIC__/Images/closeBtn.png" alt="" title="" border="0"></a></li>
    </ul>
</div>
<div id="l-map" style="display: none;"></div>
<div class="moduleOperatert">
    <form id="OrderFormCreateviewForm" method="post">
        <input type="hidden" name="returnAction" value="{$returnAction}" />
        <table border="0" cellspacing="0" cellpadding="0" width="99%" align="center">
            <tr>
                <td>
                    <table border="0" cellspacing="0" cellpadding="3" width="100%" class="small">
                        <tr>
                            <td class="dvtTabCache" style="width:20px" nowrap>&nbsp;</td>
                            <td class="dvtSelectedCell" align="center" nowrap> 新建</td>
                            <td class="dvtTabCache" style="width:80%">&nbsp;</td>
                        <tr>
                    </table>
                </td>
            </tr>

            <tr>
                <td valign="top" align="center">
                    <div class="BaseForm" style="border: 1px solid #e0dddd; background: white;">
                        <table style="BORDER-COLLAPSE: collapse" borderColor="#A9A9A9" cellSpacing="0" width="100%" align="center" border="1">
                            <tr>
                                <td colspan="4" class="tabBlockViewHeader">
                                    订单基本信息
                                </td>
                            </tr>
                            <tr style="background: #FFFFFF;">
                                <td width="15%" align="right">
                                    <span style="font-size:14px;margin-right:10px;">电话:</span>
                                </td>
                                <td width="50%" align="left">
                                    <!-- 电话 -->
                                    <input type="text" name="telphone" style="width:50%;font-size:16px;" autocomplete="off" /><span>*用户需要电子票,需要留手机号码</span>
                                </td>
                                <td width="15%" align="right">
                                    <span style="font-size:14px;margin-right:10px;">客户姓名:</span>
                                </td>
                                <td width="20%" align="left">
                                    <input type="text" name="clientname" style="font-size:16px;width:150px;" />
                                </td>
                            </tr>
                            <tr style="background: #FFFFFF;">
                                <td width="15%" align="right">
                                    <span style="font-size:14px;margin-right:10px;">地址定位:</span>
                                </td>
                                <td width="50%" align="left">
                                    <!-- 百度地址选择器 -->
                                    <input type="text" id="suggestId" size="20" value="" style="width:60%;font-size:16px;" autocomplete="off" />
                                    <div id="searchResultPanel" style="border:1px solid #C0C0C0;width:150px;height:auto; display:none;"></div>
                                    <!-- 地址坐标  -->
                                    <input type="hidden" id="longitude-create" name="longitude">
                                    <input type="hidden" id="latitude-create" name="latitude">
                                    <a href="#"> <img id="createcoordShow" src="./__PUBLIC__/Images/map-marker-icon.png" style="width:21px;height:21px;"></a>
                                    <a href="#" onclick="selectMapCoord();" style="float: right;margin-right: 20px;"><img src="./__PUBLIC__/Images/maps1.gif" style="width:21px;height:21px;border:1px solid #FFD2D2;margin-bottom:0px;margin-top:0px;padding: 0px;"
                                            align="absmiddle">选图</a>
                                </td>
                                <td width="15%" align="right">
                                    <span style="font-size:14px;margin-right:10px;">分公司:</span>
                                </td>
                                <td width="20%" align="left">
                                    <select name="company" id="OrderFormCreateviewFormCompanySelect" style="width:50%;font-size:16px;">
                                        <option></option>
                                        <foreach name="companymgr" item="vo">
                                            <option>{$vo.name}</option>
                                        </foreach>
                                    </select>
                                </td>
                            </tr>
                            <tr style="background: #FFFFFF;">
                                <td width="15%" align="right">
                                    <span style="font-size:14px;margin-right:10px;">地址:</span>
                                </td>
                                <td width="50%" align="left">
                                    <input type="text" name="address" autocomplete="off" style="font-size:16px;width: 90%;" />
                                </td>
                                <td width="15%" align="right">
                                    <span style="font-size:14px;margin-right:10px;">要餐时间:</span>
                                </td>
                                <td width="20%" align="left">
                                    <table>
                                        <tr>
                                            <td><input type="text" name="custtime_1" id="custtime_1" value="{$custtime_1}" size="2" maxlength="2" tabindex="{$vt_tab}" class="detailedViewTextBox"
                                                    AUTOCOMPLETE="off" style="width: 30px;" />
                                            </td>
                                            <td><label style="font-size: 14px;">:</label></td>
                                            <td><input type="text" name="custtime_2" id="custtime_2" value="{$custtime_2}" size="2" maxlength="2" tabindex="{$vt_tab}" class="detailedViewTextBox"
                                                    AUTOCOMPLETE="off" style="width:30px;" />
                                            </td>
                                            <td><span style="font-size: 18px;">:00</span></td>
                                        </tr>
                                    </table>
                                </td>
                            </tr>
                            <tr style="background: #FFFFFF;">
                                <td width="15%" align="right">
                                    <span style="font-size:14px;margin-right:10px;">备注:</span>
                                </td>
                                <td width="50%" align="left">
                                    <input name="beizhu" autocomplete="off" style="width:90%;font-size:16px;" />
                                </td>
                                <td width="15%" align="right">
                                    <span style="font-size:14px;margin-right:10px;">:</span>
                                </td>
                                <td width="20%" align="left">

                                </td>
                            </tr>
                            <tr style="background: #FFFFFF;">
                                <td width="15%" align="right">
                                    <span style="font-size:14px;margin-right:10px;">订单金额:</span>
                                </td>
                                <td width="50%" align="left">
                                    <table width="100%" border="1" style="BORDER-COLLAPSE: collapse" borderColor="#A9A9A9" cellSpacing="0" width="100%">
                                        <tr>
                                            <td width="10%"><span style="font-size:14px;">总金额:</span></td>
                                            <td width="20%"><span id="OrderFormCreateviewFormTotalMoney" style="font-size:16px;"></span>
                                                <input type="text" name="totalmoney" readonly="true" hidden="true" style="font-size:16px;" size="10" />
                                            </td>
                                            <td width="10%"><span style="font-size:14px;">已收金额:</span></td>
                                            <td width="20%">
                                                <span id="OrderFormCreateviewFormPaidMoney" style="font-size:16px;"></span>
                                                <input type="text" name="moneypaid" readonly="true" hidden="true" style="font-size:16px;" size="10" />
                                            </td>
                                            <td width="10%"><span style="font-size:14px;">应收金额:</span></td>
                                            <td width="15%">
                                                <span id="OrderFormCreateviewFormShouldMoney" style="font-size:16px;"></span>
                                                <input type="text" name="shouldmoney" readonly="true" hidden="true" style="font-size:16px;" size="10" />
                                            </td>
                                        </tr>
                                    </table>
                                </td>
                                <td width="15%" align="right">
                                    <span style="font-size:14px;margin-right:10px;">送餐费:</span>
                                </td>
                                <td width="20%" align="left">
                                    <input type="text" name="shippingmoney" style="font-size:16px;" value="" />

                                </td>
                            </tr>
                        </table>

                        <table border="0" cellspacing="0" cellpadding="0" width="100%" style="margin-top:5px; border: 1px solid #e0dddd; ">
                            <tr>
                                <td colspan="4" class="tabBlockViewHeader">
                                    产品基本信息
                                </td>
                            </tr>
                            <tr style="background: #FFFFFF;">
                                <td colspan="4">
                                    <include file='ModuleUI:goodseditview' />
                                </td>
                            </tr>
                            <tr style="line-height: 5px;">
                                <td>&nbsp;</td>
                            </tr>
                        </table>

                        <table border="0" cellspacing="0" cellpadding="0" width="100%" style="margin-top:5px; border: 1px solid #e0dddd; ">
                            <tr>
                                <td colspan="4" class="tabBlockViewHeader">
                                    发票基本信息
                                </td>
                            </tr>
                            <tr style="background: #FFFFFF;">
                                <td colspan="4">
                                    <include file='ModuleUI:invoiceeditview' />
                                </td>
                            </tr>
                        </table>

                        <table border="0" cellspacing="0" cellpadding="0" width="100%" style="margin-top:5px; border: 1px solid #e0dddd; ">
                            <tr>
                                <td colspan="4" class="tabBlockViewHeader">
                                    客户支付输入信息
                                </td>
                            </tr>
                            <tr style="background: #FFFFFF;">
                                <td colspan="4">
                                    <include file='accountpaymenteditview' />
                                </td>
                            </tr>
                        </table>

            <tr style="line-height: 5px;">
                <td>&nbsp;</td>
            </tr>

            <tr style="line-height: 5px;">
                <td colspan="4" align="center">
                    <a href="#" class="easyui-linkbutton" data-options="iconCls:'icons-other-tick'" onclick="OrderFormCreateviewModule.insert();" style="width:100px;margin-right:40px;">确认</a>
                    <a href="#" class="easyui-linkbutton" data-options="iconCls:'icons-arrow-cross'" onclick="IndexIndexModule.updateOperateTab('__URL__/listview');" style="width:100px;">放弃</a>
                </td>
            </tr>
</div>
</td>
</tr>
</table>
</form>
</div>

<input id="OrderFormAction" type="hidden" value="Createview" />
<script>
    var OrderFormCreateviewModule = {
        dialog: '#globel-dialog-div',
        checkSubmitFlg: false,
        //初始化
        init: function () {
            $('.moduleOperatert').height(IndexIndexModule.operationHeight);
            this.quickKeyboardAction();
            //键盘移动
            this.keyboardMove();
            this.varifyCusttime();
            $('#createcoordShow').hide();
        },

        //保存记录
        insert: function () {
            //防止重复提交
            if (this.checkSubmitFlg == false) {
                this.checkSubmitFlg = true;
            } else {
                return;
            }
            $('#OrderFormCreateviewForm').form('submit', {
                url: '__URL__/insert',
                onSubmit: function () {
                    //如果返回false阻止提交
                    if ($('#OrderFormCreateviewForm input[name=address]').val() == '') {
                        alert('地址不能为空!');
                        OrderFormCreateviewModule.checkSubmitFlg = false;
                        return false;
                    };

                    var custtime_1 = $('#OrderFormCreateviewForm input[name=custtime_1]').val();
                    if (custtime_1 > 24 || custtime_1 < 0) {
                        alert('时间输入不正确!请输入1-24之间的数字!');
                        OrderFormCreateviewModule.checkSubmitFlg = false;
                        return false;
                    };

                    var custtime_1 = $('#OrderFormCreateviewForm input[name=custtime_2]').val();
                    if (custtime_1 > 60 || custtime_1 < 0) {
                        alert('时间输入不正确!请输入1-60之间的数字!');
                        OrderFormCreateviewModule.checkSubmitFlg = false;
                        return false;
                    }

                    //订单一定要有坐标位置
                    longitude_create = $('#longitude-create').val();
                    latitude_create = $('#latitude-create').val();
                    if (longitude_create === '') {
                        var lt = confirm('没有坐标,是否需要保存?');
                        if (lt == true) {

                        } else {
                            OrderFormCreateviewModule.checkSubmitFlg = false;
                            return false;
                        }
                    };

                    //对金额进行校验
                    productsMoney = $('#OrderFormCreateviewproductsTotalMoney').val(); //产品金额
                    if (!productsMoney) {
                        productsMoney = 0;
                    } else {
                        productsMoney = parseFloat(productsMoney);
                    }
                    activityMoney = $('#OrderFormCreateviewactivityTotalMoney').val(); //活动金额
                    if (!activityMoney) {
                        activityMoney = 0;
                    } else {
                        activityMoney = parseFloat(activityMoney);
                    }
                    accountpaymentMoney = $("#OrderFormAccountPaymentTotalMoney").val(); //客户支付金额
                    if (!accountpaymentMoney) {
                        accountpaymentMoney = 0;
                    } else {
                        accountpaymentMoney = parseFloat(accountpaymentMoney);
                    }
                    checkactivitypaymentMoney = activityMoney + accountpaymentMoney;
                    if (accountpaymentMoney > 0) {
                        if (productsMoney !== checkactivitypaymentMoney) {
                            alert('活动金额和支付金额不等于订餐金额，请检查！');
                            OrderFormCreateviewModule.checkSubmitFlg = false;
                            return false;
                        }
                    }


                    /**201801202去掉
                    var invoice_invoicetype = $('#invoice_type').val();
                    if(invoice_invoicetype == '电子票'){
                        var telphone = $('#OrderFormCreateviewForm input[name=telphone]').val();
                        var telReg = !!telphone.match(/^(0|86|17951)?(13[0-9]|15[012356789]|17[678]|18[0-9]|14[57]|19[0-9])[0-9]{8}$/);
                        //如果手机号码不能通过验证
                        if(telReg == false){
                            alert('输入的不是电话号码');
                            OrderFormCreateviewModule.checkSubmitFlg = false;
                            return false;
                        }
                    }

                    var invoice_header = $('#invoice_header').val();
                    if(invoice_header){
                        var invoice_nsrsbh = $('#invoice_gmf_nsrsbh').val();
                        if(!invoice_nsrsbh){
                            alert('购买方纳税人识别号(税号)不能为空!');
                            OrderFormCreateviewModule.checkSubmitFlg = false;
                            return false;
                        }
                    }
                    **/

                    /**
                    if(latitude_create === '' ){
                        alert('必须要有坐标!');
                        OrderFormCreateviewModule.checkSubmitFlg = false;
                        return false;
                    }
                     */

                    var isValid = $('#OrderFormCreateviewForm').form('validate');
                    if (!isValid) {
                        return false;
                    }
                },
                success: function (res) {
                    var data = eval('(' + res + ')');
                    if (!data.status) {
                        $.app.method.tip('提示信息', data.info, 'error');
                        OrderFormCreateviewModule.checkSubmitFlg = false;
                        return false;
                    } else {
                        $.app.method.tip('提示信息', data.info, 'info');
                        IndexIndexModule.updateOperateTab(data.url);
                    }
                }
            });
        },

        //新建的快捷操作
        quickKeyboardAction: function () {
            // ctrl+9快捷键,保存公告
            Mousetrap.bind(['ctrl+9', 'ctrl+f9', 'f9'], function (e) {
                // 返回选项卡
                var tab = $('#operation').tabs('getSelected');
                var tabOptions = tab.panel('options');
                if (tabOptions.title == '订餐单' && ($('#OrderFormAction').val() == 'Createview')) {
                    OrderFormCreateviewModule.insert();
                };
            });

            // ctrl+4快捷键,放弃
            Mousetrap.bind(['ctrl+4', 'ctrl+f4', 'f4'], function (e) {
                // 返回选项卡
                var tab = $('#operation').tabs('getSelected');
                var tabOptions = tab.panel('options');
                if (tabOptions.title == '订餐单' && ($('#OrderFormAction').val() == 'Createview')) {
                    IndexIndexModule.updateOperateTab('__URL__/listview');
                };
            });

            // ctrl+0快捷键,查看今日菜单
            Mousetrap.bind(['ctrl+0', 'ctrl+f10', 'f10'], function (e) {
                // 返回选项卡
                var tab = $('#operation').tabs('getSelected');
                var tabOptions = tab.panel('options');
                if (tabOptions.title == '订餐单' && ($('#OrderFormAction').val() == 'Createview')) {
                    OrderFormCreateviewModule.showTodayMenuview();
                };
            });
        },


        //键盘移动方案
        keyboardMove: function () {
            //定制键盘移动方案
            $('#OrderFormCreateviewForm input[name=clientname]').bind('keydown', function (event) { //联系人
                if ((event.which == 13) || (event.which == 40)) {
                    $('#OrderFormCreateviewForm input[name=telphone]').focus();
                }
                if (event.which == 38) {

                }
            })

            //电话移动
            $('#OrderFormCreateviewForm input[name=telphone]').bind('keydown', function (event) {
                if ((event.which == 13) || (event.which == 40)) { //下移
                    var address = $('#OrderFormCreateviewForm input[name=address]').val();
                    $('#OrderFormCreateviewForm input[name=address]').focus();
                    $('#OrderFormCreateviewForm input[name=address]').val();
                    $('#OrderFormCreateviewForm input[name=address]').val(address);

                }
                if (event.which == 38) { //上移
                    $('#OrderFormCreateviewForm input[name=clientname]').focus();
                }
            })

            //地址移动
            $('#OrderFormCreateviewForm input[name=address]').bind('keydown', function (event) {
                if ((event.which == 13) || (event.which == 40)) { //下移
                    $('#OrderFormCreateviewForm input[name=custtime_1]').focus();
                }
                if (event.which == 38) { //上移
                    $('#OrderFormCreateviewForm input[name=telphone]').focus();
                }

            })

            //要餐时间1移动
            $('#OrderFormCreateviewForm input[name=custtime_1]').bind('keydown', function (event) {
                if ((event.which == 13) || (event.which == 40)) { //下移
                    var custtime_1 = $('#OrderFormCreateviewForm input[name=custtime_1]').val();
                    if (custtime_1 > 24 || custtime_1 < 0) {
                        alert('时间输入不正确!请输入1-24之间的数字!');
                        return false;
                    }
                    $('#OrderFormCreateviewForm input[name=custtime_2]').focus();
                }
                if (event.which == 38) { //上移
                    var custtime_1 = $('#OrderFormCreateviewForm input[name=custtime_1]').val();
                    if (custtime_1 > 24 || custtime_1 < 0) {
                        alert('时间输入不正确!请输入1-24之间的数字!');
                        return false;
                    }
                    var address = $('#OrderFormCreateviewForm input[name=address]').val();
                    $('#OrderFormCreateviewForm input[name=address]').focus();
                    $('#OrderFormCreateviewForm input[name=address]').val('');
                    $('#OrderFormCreateviewForm input[name=address]').val(address);
                }
            })

            //要餐时间2移动
            $('#OrderFormCreateviewForm input[name=custtime_2]').bind('keydown', function (event) {
                if ((event.which == 13) || (event.which == 40)) { //下移
                    var custtime_1 = $('#OrderFormCreateviewForm input[name=custtime_2]').val();
                    if (custtime_1 > 60 || custtime_1 < 0) {
                        alert('时间输入不正确!请输入1-60之间的数字!');
                        return false;
                    }
                    $('#OrderFormCreateviewForm input[name=beizhu]').focus();
                }
                if (event.which == 38) { //上移
                    var custtime_1 = $('#OrderFormCreateviewForm input[name=custtime_2]').val();
                    if (custtime_1 > 60 || custtime_1 < 0) {
                        alert('时间输入不正确!请输入1-60之间的数字!');
                        return false;
                    }
                    $('#OrderFormCreateviewForm input[name=custtime_1]').focus();
                }
            })


            //备注的移动
            $('#OrderFormCreateviewForm input[name=beizhu]').bind('keydown', function (event) {
                if ((event.which == 13) || (event.which == 40)) { //下移
                    $('#OrderFormCreateviewForm input[name=productsNumber_1]').focus();

                }
                if (event.which == 38) { //上移
                    $('#OrderFormCreateviewForm input[name=custtime_2]').focus();
                }

            })

            //产品1的移动
            $('#OrderFormCreateviewForm input[name=productsNumber_1]').bind('keydown', function (event) {
                if (event.which == 38) { //上移
                    $('#OrderFormCreateviewForm input[name=beizhu]').focus();
                }

            })


            //送餐费的计算
            $('#OrderFormCreateviewForm input[name=shippingmoney]').bind('keydown', function (event) {
                if (event.which == 13) {
                    //计算全部的金额
                    var totalMoney = 0;
                    //取得表格行的长度
                    var rowLength = $("#OrderFormCreateviewproductsTable tr").length;
                    for (i = 1; i < rowLength; i++) {
                        if ($("#OrderFormCreateviewproductsMoney_" + i).val() > 0) {
                            totalMoney = totalMoney + parseFloat($("#OrderFormCreateviewproductsMoney_" +
                                i).val());
                        }
                    }

                    //加上送餐费
                    var shippingmoney = 0;
                    var shippingmoneyVal = $('#OrderFormCreateviewForm input[name=shippingmoney]').val();
                    if (shippingmoneyVal) {
                        shippingmoney = parseFloat(shippingmoneyVal);
                    }
                    totalMoney = totalMoney + shippingmoney;
                    totalMoney = parseFloat(totalMoney).toFixed(2);
                    $('#OrderFormCreateviewFormTotalMoney').html(totalMoney + '元'); //订单总金额
                    $('#OrderFormCreateviewForm input[name=totalmoney]').val(totalMoney);
                    $('#OrderFormCreateviewFormShouldMoney').html(totalMoney + '元'); //应收金额
                    $('#OrderFormCreateviewForm input[name=shouldmoney]').val(totalMoney);
                    //
                    $('#OrderFormCreateviewForm input[name=productsNumber_1]').focus();

                };
            })
        },

        //要餐时间的规则限制,失去焦点的时候,时在1-24之间,分在0-60直接
        varifyCusttime: function () {

            //时验证
            $('#OrderFormCreateviewForm input[name=custtime_1]').bind('blur', function (event) {

            });

            //分验证
            $('#OrderFormCreateviewForm input[name=custtime_2]').bind('blur', function (event) {

            });
        },

        showTodayMenuview: function () {
            var that = this;
            $(that.dialog).dialog({
                title: '今日菜单查询',
                iconCls: 'icons-application-application_add',
                width: 600,
                height: 540,
                cache: false,
                href: "{:U('OrderForm/showToaymenuview')}",
                modal: true,
                collapsible: false,
                minimizable: false,
                resizable: false,
                maximizable: false,
                buttons: [{
                    text: '关闭',
                    iconCls: 'icons-arrow-cross',
                    handler: function () {
                        $(that.dialog).dialog('close');
                    }
                }]
            });
        }
    }

    $(function () {
        OrderFormCreateviewModule.init();
        setTimeout(function () {
            $('#OrderFormCreateviewForm input[name=address]').focus();
        }, 100);

    })
</script>

<script type="text/javascript">
    // 百度地图API功能
    function G(id) {
        return document.getElementById(id);
    }

    var map = new BMap.Map("l-map");
    map.centerAndZoom("{$city}", 12); // 初始化地图,设置城市和地图级别。

    var ac = new BMap.Autocomplete( //建立一个自动完成的对象
        {
            "input": "suggestId",
            "location": map
        });

    ac.addEventListener("onhighlight", function (e) { //鼠标放在下拉列表上的事件
        var str = "";
        var _value = e.fromitem.value;
        var value = "";
        if (e.fromitem.index > -1) {
            value = _value.province + _value.city + _value.district + _value.street + _value.business;
        }
        str = "FromItem<br />index = " + e.fromitem.index + "<br />value = " + value;

        value = "";
        if (e.toitem.index > -1) {
            _value = e.toitem.value;
            value = _value.province + _value.city + _value.district + _value.street + _value.business;
        }
        str += "<br />ToItem<br />index = " + e.toitem.index + "<br />value = " + value;
        G("searchResultPanel").innerHTML = str;
    });

    var myValue;
    ac.addEventListener("onconfirm", function (e) { //鼠标点击下拉列表后的事件
        var _value = e.item.value;
        myValue = _value.province + _value.city + _value.district + _value.street + _value.business;
        G("searchResultPanel").innerHTML = "onconfirm<br />index = " + e.item.index + "<br />myValue = " +
            myValue;
        /** 这个功能,要以后用的
        var address = $('#OrderFormCreateviewForm input[name=address]').val();
        if(address){
            address = myValue + ' ' + address;
            $('#OrderFormCreateviewForm input[name=address]').val(address);
        }else{
            $('#OrderFormCreateviewForm input[name=address]').val(myValue);
        }
         **/
        setPlace();
    });

    function setPlace() {
        //map.clearOverlays();    //清除地图上所有覆盖物
        function myFun() {
            var pp = local.getResults().getPoi(0).point; //获取第一个智能搜索的结果
            var point = new BMap.Point(pp.lng, pp.lat);

            $('#longitude-create').val(pp.lng);
            $('#latitude-create').val(pp.lat);
            $('#createcoordShow').show();

            //搜索分公司的配送区域
            $.each(companyRegion, function (key, val) {
                //设置分公司的配送范围
                var region = val.region;
                //拆成数组
                var regionArray = region.split(',');

                var reg = new Array();
                for (i = 0; i < regionArray.length; i++) {
                    reg.push(new BMap.Point(regionArray[i], regionArray[i + 1]));
                    i = i + 1;
                }

                //画出送餐范围
                var polygon = new BMap.Polygon(reg, {});
                map.addOverlay(polygon);
                //判断点是否在
                if (BMapLib.GeoUtils.isPointInPolygon(point, polygon)) {
                    if (val['telphoneauto'] == '营业') {
                        //如果在这个区域,设置分公司
                        $('#OrderFormCreateviewFormCompanySelect').val(key);
                        //设置坐标
                        $('#longitude-create').val(pp.lng);
                        $('#latitude-create').val(pp.lat);
                        $('#createcoordShow').show();
                        return false;
                    }
                    if (val['telphoneauto'] == '休息') {
                        alert(key + '分公司休息,不营业!');
                        return false;
                    }

                    if (val['telphoneauto'] == '休息') {
                        //设置坐标
                        $('#longitude-create').val(pp.lng);
                        $('#latitude-create').val(pp.lat);
                        $('#createcoordShow').show();
                        return false;
                    }

                } else {
                    //如果在这个区域,设置空
                    //$('#OrderFormCreateviewFormCompanySelect').val('');
                    //设置空
                    $('#longitude-create').val(pp.lng);
                    $('#latitude-create').val(pp.lat);
                    $('#createcoordShow').show();
                    return true;
                }
            });

        }
        var local = new BMap.LocalSearch(map, { //智能搜索
            onSearchComplete: myFun
        });
        local.search(myValue);
    }

    //弹出地图框,选择地址
    function selectMapCoord() {
        var url = "__URL__/showArea";
        $('#globel-dialog-div').dialog({
            title: '选择地址',
            iconCls: 'icons-application-application_add',
            width: 900,
            height: 540,
            cache: false,
            href: url,
            modal: true,
            collapsible: false,
            minimizable: false,
            resizable: false,
            maximizable: false,
            buttons: [{
                id: 'selectAddressShow',
                text: '地址:',
                plain: true

            }, {
                text: '确定',
                iconCls: 'icons-other-tick',
                handler: function () {
                    $('#OrderFormCreateviewForm input[name=address]').val(areaSelectAddress);
                    var pp = areaSelectPoint; //获取第一个智能搜索的结果
                    var point = new BMap.Point(pp.lng, pp.lat);

                    //搜索分公司的配送区域
                    $.each(companyRegion, function (key, val) {
                        //设置分公司的配送范围
                        var region = val.region;
                        //拆成数组
                        var regionArray = region.split(',');

                        var reg = new Array();
                        for (i = 0; i < regionArray.length; i++) {
                            reg.push(new BMap.Point(regionArray[i], regionArray[i + 1]));
                            i = i + 1;
                        }

                        //画出送餐范围
                        var polygon = new BMap.Polygon(reg, {});
                        map.addOverlay(polygon);
                        //判断点是否在
                        if (BMapLib.GeoUtils.isPointInPolygon(point, polygon)) {
                            if (val['telphoneauto'] == '营业') {
                                //如果在这个区域,设置分公司
                                $('#OrderFormCreateviewFormCompanySelect').val(key);
                                //设置坐标
                                $('#longitude-create').val(pp.lng);
                                $('#latitude-create').val(pp.lat);
                                $('#createcoordShow').show();
                                return false;
                            }
                            if (val['telphoneauto'] == '休息') {
                                alert(key + '分公司休息,不营业!');
                                return false;
                            }
                            if (val['telphoneauto'] == '休息') {
                                //设置坐标
                                $('#longitude-create').val(pp.lng);
                                $('#latitude-create').val(pp.lat);
                                $('#createcoordShow').show();
                                return false;
                            }
                        } else {
                            //如果在这个区域,设置空
                            //$('#OrderFormCreateviewFormCompanySelect').val('');
                            //设置空
                            $('#longitude-create').val(pp.lng);
                            $('#latitude-create').val(pp.lat);
                            $('#createcoordShow').show();
                            return true;
                        }
                    });
                    $('#globel-dialog-div').dialog('close');
                }
            }, {
                text: '取消',
                iconCls: 'icons-arrow-cross',
                handler: function () {
                    $('#globel-dialog-div').dialog('close');
                }
            }]
        });

    }
</script>