<style>
    #productsTable {
        background-color: transparent;
    }

    .productsTableHeader {
        background-color: #008B00;
        font-size: 12px;
    }

    #productsTable td{
        height: 25px;
    }

    #productsTable span{
        font-size:16px;
    }

    #productsTable input{
        font-size : 16px;
    }

</style>
<table id="{$moduleName}{$Think.ACTION_NAME|ucfirst}productsTable" style="BORDER-COLLAPSE: collapse"  borderColor="#CCCCCC" cellSpacing="0" width="100%"
       align="center" border="1">
    <tr class="productsTableHeader">
        <td width="5%" align="center" class="productsTableHeaderLeftTd">序号</td>
        <td width="12%" align="center" class="productsTableHeaderLeftTd">数量</td>
        <td width="15%" align="center" class="productsTableHeaderLeftTd">产品代码</td>
        <td width="30%" align="center" class="productsTableHeaderLeftTd">产品名称</td>
        <td width="12%" align="center" class="productsTableHeaderLeftTd">单价</td>
        <td width="15%" align="center" class="productsTableHeaderLeftTd">金额</td>
        <td width="10%" align="center" class="productsTableHeaderRightTd">操作</td>
    </tr>
    <empty name="orderproducts">
        <for start="0" end="3" name="key">
            <tr>
                <td width="5%" align="center" >{$key+1}</td>
                <td width="15%" align="center" > {//数量}
                    <input id="{$moduleName}{$Think.ACTION_NAME|ucfirst}productsNumber_{$key+1}" name="productsNumber_{$key+1}" type="text" size="5" tabindex="1"
                           onkeydown="{$moduleName}{$Think.ACTION_NAME|ucfirst}GoodsEditViewModule.keydownSumProductsMoney({$key+1},event,this)"
                           onblur="{$moduleName}{$Think.ACTION_NAME|ucfirst}GoodsEditViewModule.blurkeydownSumProductsMoney({$key+1},this)" value=""
                           AUTOCOMPLETE="off"
                           style="font-size:16px;"/>
                </td>
                <td width="10%" align="center" "> {//产品代码}
                    <input id="{$moduleName}{$Think.ACTION_NAME|ucfirst}productsCode_{$key+1}" name="productsCode_{$key+1}" type="text" size="10" tabindex="1"
                           onkeydown="{$moduleName}{$Think.ACTION_NAME|ucfirst}GoodsEditViewModule.getProductsByCode({$key+1},event,this);" AUTOCOMPLETE="off"
                           style="font-size:16px;"/>

                    <img id="{$moduleName}{$Think.ACTION_NAME|ucfirst}searchIcon1" title="产品选择" src="./__PUBLIC__/Images/products.gif" style="cursor: pointer;"
                         align="absmiddle"
                         onclick="{$moduleName}{$Think.ACTION_NAME|ucfirst}GoodsEditViewModule.productsPickList('__URL__/popupProductsview/module/Products/row/{$key+1}');"/><a
                            href="javascript:{$moduleName}{$Think.ACTION_NAME|ucfirst}GoodsEditViewModule.productsPickList('__URL__/popupProductsview/module/Products/row/{$key+1}')">选择</a>
                </td>
                <td width="30%" align="center" > {//产品名称}
                    <input id="{$moduleName}{$Think.ACTION_NAME|ucfirst}productsName_{$key+1}" name="productsName_{$key+1}" type="text" size="30"
                           readonly="readonly" style="font-size:16px;"/>
                    <input id="{$moduleName}{$Think.ACTION_NAME|ucfirst}productsShortName_{$key+1}" name="productsShortName_{$key+1}" size="30" type="hidden"
                           style="font-size:16px;"/>
                </td>
                <td width="15%" align="center" > {//单价}
                    <input id="{$moduleName}{$Think.ACTION_NAME|ucfirst}productsPrice_{$key+1}" name="productsPrice_{$key+1}" type="text" size="10"
                           readonly="readonly" tabindex="1"
                           onblur="{$moduleName}{$Think.ACTION_NAME|ucfirst}GoodsEditViewModule.blurkeydownSumProductsMoney({$key+1},this)" value="" style="font-size:16px;"/>
                    <img id="{$moduleName}{$Think.ACTION_NAME|ucfirst}searchIcon1" title="产品选择" src="./__PUBLIC__/Images/products.gif" style="cursor: pointer;"
                         align="absmiddle"
                         onclick="{$moduleName}{$Think.ACTION_NAME|ucfirst}GoodsEditViewModule.setGoodsPrice('{$key+1}');"/>
                </td>
                <td width="15%" align="center" > {//金额}
                    <input id="{$moduleName}{$Think.ACTION_NAME|ucfirst}productsMoney_{$key+1}" name="productsMoney_{$key+1}" type="text" size="10"
                           readonly="readonly" tabindex="1" value="" style="font-size:16px;"/>
                </td>
                <td width="10%" align="center" ><a href="#" onclick="{$moduleName}{$Think.ACTION_NAME|ucfirst}GoodsEditViewModule.clearProducts({$key+1});">清空产品</a>
                </td>
            </tr>
        </for>
    </empty>
    <foreach name="orderproducts" item="vo">
        <tr>
            <td width="5%" align="center" >{$key+1}</td>
            <td width="15%" align="center" > {//数量}
                <input id="{$moduleName}{$Think.ACTION_NAME|ucfirst}productsNumber_{$key+1}" name="productsNumber_{$key+1}" type="text" size="5" tabindex="1"
                       value="{$vo.number}" onkeydown="{$moduleName}{$Think.ACTION_NAME|ucfirst}GoodsEditViewModule.keydownSumProductsMoney({$key+1},event,this)"
                       onblur="{$moduleName}{$Think.ACTION_NAME|ucfirst}GoodsEditViewModule.sumProductsMoney({$key+1},this);" AUTOCOMPLETE="off"
                       style="font-size:16px;"/>
            </td>
            <td width="10%" align="center" > {//产品代码}
                <input id="{$moduleName}{$Think.ACTION_NAME|ucfirst}productsCode_{$key+1}" name="productsCode_{$key+1}" type="text" size="10" tabindex="1"
                       value="{$vo.code}" onkeydown="{$moduleName}{$Think.ACTION_NAME|ucfirst}GoodsEditViewModule.getProductsByCode({$key+1},event,this);"
                        AUTOCOMPLETE="off" style="font-size:16px;"/>
                <img id="{$moduleName}{$Think.ACTION_NAME|ucfirst}searchIcon1" title="产品选择" src="./__PUBLIC__/Images/products.gif" style="cursor: pointer;"
                     align="absmiddle"
                     onclick="{$moduleName}{$Think.ACTION_NAME|ucfirst}GoodsEditViewModule.productsPickList('__URL__/popupProductsview/module/Products/row/{$key+1}');"/><a
                        href="javascript:{$moduleName}{$Think.ACTION_NAME|ucfirst}GoodsEditViewModule.productsPickList('__URL__/popupProductsview/module/Products/row/{$key+1}')">选择</a>
            </td>
            <td width="30%" align="center" > {//产品名称}
                <input id="{$moduleName}{$Think.ACTION_NAME|ucfirst}productsName_{$key+1}" name="productsName_{$key+1}" type="text" size="30" readonly="readonly"
                       value="{$vo.name}"  style="font-size:16px;"/>
                <input id="{$moduleName}{$Think.ACTION_NAME|ucfirst}productsShortName_{$key+1}" name="productsShortName_{$key+1}" type="hidden"
                       value="{$vo.shortname}" style="font-size:16px;"/>
            </td>
            <td width="15%" align="center" > {//单价}
                <input id="{$moduleName}{$Think.ACTION_NAME|ucfirst}productsPrice_{$key+1}" name="productsPrice_{$key+1}" type="text" size="10"
                       readonly="readonly" tabindex="1" value="{$vo.price}" style="font-size:16px;"/>
            </td>
            <td width="15%" align="center" > {//金额}
                <input id="{$moduleName}{$Think.ACTION_NAME|ucfirst}productsMoney_{$key+1}" name="productsMoney_{$key+1}" type="text" size="10"
                       readonly="readonly" tabindex="1" value="{$vo.money}" style="font-size:16px;"/>
            </td>
            <td width="10%" align="center" ><a href="#" onclick="{$moduleName}{$Think.ACTION_NAME|ucfirst}GoodsEditViewModule.clearProducts('{$key+1}');">清空产品</a>
            </td>
        </tr>
    </foreach>

</table>
<table width="100%" style="BORDER-COLLAPSE: collapse"  borderColor="#CCCCCC" cellSpacing="0" width="100%"
       align="center" border="1">
    <tr>
        <td class="productsTableXiaojiLeftTd" width="65%">
            <a href="#" class="easyui-linkbutton" data-options="iconCls:'icons-car_cart_basket-basket_add'"
               onclick="{$moduleName}{$Think.ACTION_NAME|ucfirst}GoodsEditViewModule.addProducts();" style="font-size:16px;">添加产品行</a>
            <a href="#" class="easyui-linkbutton" data-options="iconCls:'icons-car_cart_basket-basket_delete'"
               onclick="{$moduleName}{$Think.ACTION_NAME|ucfirst}GoodsEditViewModule.delProducts();" style="font-size:16px;margin-left:30px;">删除产品最后一行</a>
            <input id="{$moduleName}{$Think.ACTION_NAME|ucfirst}productsLength" name="productsLength" type="hidden" value="{$key+1}"/>
        </td>

        <td style="font-size: 16px;">
            <span>份数:</span>
            <span id="productsTotalNumber"></span>
        </td>
        <td class="productsTableXiaojiRightTd" style="font-size: 14px;"> {// 金额小计}
            <span>小计</span>
            <input id="{$moduleName}{$Think.ACTION_NAME|ucfirst}productsTotalMoney" name="productsTotalMoney" type="text" size="10" readonly="readonly"
                   style="border: 0px;font-size: 14px;" value="{$orderproductsmoney}"/>
        </td>
    </tr>
</table>

<script type="text/javascript">
    var {$moduleName}{$Think.ACTION_NAME|ucfirst}GoodsEditViewModule = {

        init: function () {

        },


        //添加产品
        addProducts: function () {
            //取得表格行的长度
            var rowNum = $("#{$moduleName}{$Think.ACTION_NAME|ucfirst}productsTable tr").length;

            var tableTrAppend = "<tr> ";
            tableTrAppend += "<td width='5%' align='center' class='productsTableLeftTd'>" + rowNum + "</td> ";
            tableTrAppend += "<td width='15%' align='center' class='productsTableLeftTd'>";
            tableTrAppend += "<input id='{$moduleName}{$Think.ACTION_NAME|ucfirst}productsNumber_" + rowNum + "' name='productsNumber_" + rowNum + "' type='text' size='5' value='' tabindex='1' onkeydown='{$moduleName}{$Think.ACTION_NAME|ucfirst}GoodsEditViewModule.keydownSumProductsMoney(" + rowNum + ",event,this)' onblur='{$moduleName}{$Think.ACTION_NAME|ucfirst}GoodsEditViewModule.blurkeydownSumProductsMoney(" + rowNum + ",event,this)' value='' AUTOCOMPLETE='off' style='font-size:16px;' />";
            tableTrAppend += "</td>";
            tableTrAppend += "<td width='15%' align='center' class='productsTableLeftTd'>";
            tableTrAppend += "<input class='easyui-numberbox' id='{$moduleName}{$Think.ACTION_NAME|ucfirst}productsCode_" + rowNum + "' name='productsCode_" + rowNum + "'  type='text' size='10' tabindex='1' onkeyup='{$moduleName}{$Think.ACTION_NAME|ucfirst}GoodsEditViewModule.getProductsByCode(" + rowNum + ",event,this)' style='font-size:16px;' />";
            tableTrAppend += "<img id='{$moduleName}{$Think.ACTION_NAME|ucfirst}searchIcon1' title='产品选择' src='./" + PUBLIC + "/Images/products.gif' style='cursor: pointer;' align='absmiddle' onclick='{$moduleName}{$Think.ACTION_NAME|ucfirst}GoodsEditViewModule.productsPickList(\"__APP__/OrderForm/popupview/module/Products/row/" + rowNum + "\");' />";
            tableTrAppend += "<a href='javascript:{$moduleName}{$Think.ACTION_NAME|ucfirst}GoodsEditViewModule.productsPickList(\"__URL__/popupProductsview/module/Products/row/" + rowNum + "\");' >选择</a>";
            tableTrAppend += "</td>";
            tableTrAppend += "<td width='15%' align='center' class='productsTableLeftTd'>";
            tableTrAppend += "<input id='{$moduleName}{$Think.ACTION_NAME|ucfirst}productsName_" + rowNum + "' name='productsName_" + rowNum + "' type='text' size='30' readonly='readonly' style='font-size:16px;'  />";
            tableTrAppend += "<input id='{$moduleName}{$Think.ACTION_NAME|ucfirst}productsShortName_" + rowNum + "' name='productsShortName_" + rowNum + "' type='hidden'  />";
            tableTrAppend += "</td>";
            tableTrAppend += "<td width='15%' align='center' class='productsTableLeftTd'>";
            tableTrAppend += "<input id='{$moduleName}{$Think.ACTION_NAME|ucfirst}productsPrice_" + rowNum + "' name='productsPrice_" + rowNum + "' type='text' size='10' readonly='readonly' tabindex='1' value='' style='font-size:16px;' />";
            tableTrAppend += "</td>";
            tableTrAppend += "<td width='15%' align='center' class='productsTableLeftTd'>";
            tableTrAppend += "<input id='{$moduleName}{$Think.ACTION_NAME|ucfirst}productsMoney_" + rowNum + "' name='productsMoney_" + rowNum + "' type='text' size='10' readonly='readonly'  tabindex='1' value='' style='font-size:16px;' />";
            tableTrAppend += "</td>";
            tableTrAppend += "<td width='10%' align='center' class='productsTableLeftTd'><a href='#' onclick='{$moduleName}{$Think.ACTION_NAME|ucfirst}GoodsEditViewModule.clearProducts(" + rowNum + ");' >清空产品</a></td>";
            tableTrAppend += "</tr>";
            $("#{$moduleName}{$Think.ACTION_NAME|ucfirst}productsTable").append(tableTrAppend);
            $("#{$moduleName}{$Think.ACTION_NAME|ucfirst}productsLength").attr("value", rowNum + 1);  //表格行数保存
        },

        /* 键盘回车计算产品金额 */
        keydownSumProductsMoney: function (rowNum, evt, obj) {
            evt = evt ? evt : ((window.event) ? window.event : null);
            var key = evt.keyCode ? evt.keyCode : evt.which;
            if (key == 13) {
                if ($("#{$moduleName}{$Think.ACTION_NAME|ucfirst}productsName_" + rowNum).val() != '') {    //如果不为空，才计算
                    this.sumProductsMoney(rowNum);
                }
                $("#{$moduleName}{$Think.ACTION_NAME|ucfirst}productsCode_" + rowNum).focus();
            }
            //向上移动一个
            if (key == 38) {
                var focusNum = rowNum - 1;
                if (focusNum > 0) {
                    $("#{$moduleName}{$Think.ACTION_NAME|ucfirst}productsCode_" + focusNum).focus();
                }
            }
            //向下移动
            if (key == 40) {
                $("#{$moduleName}{$Think.ACTION_NAME|ucfirst}productsCode_" + rowNum).focus();
            }
        },

        //产品数量输入框失去焦点
        blurkeydownSumProductsMoney: function (rowNum, obj) {
            this.sumProductsMoney(rowNum);
        },

        /* 通过产品代码取得产品 */
        // rowNum 是行号，evt是firefox下的event事件，obj是this指针
        getProductsByCode: function (rowNum, evt, obj) {
            evt = evt ? evt : ((window.event) ? window.event : null);
            var key = evt.keyCode ? evt.keyCode : evt.which;
            var code = $(obj).val();

            if ((key == 13) && (code.length > 0)) {
                this.getProducts(rowNum, code);
            }
            //向上移动
            if (key == 38) {
                $("#{$moduleName}{$Think.ACTION_NAME|ucfirst}productsNumber_" + rowNum).focus();
            }
            //向下移动
            if (key == 40) {
                var focusNum = rowNum + 1;
                $("#{$moduleName}{$Think.ACTION_NAME|ucfirst}productsNumber_" + focusNum).focus();
            }

        },

        /* 弹出窗口，选择产品 */
        //moduleName:产品名称  rowNum:行号 moduleName,rowNum
        productsPickList: function (url) {
            url = url + '/returnModule/'+'{$moduleName}{$Think.ACTION_NAME|ucfirst}';
            $('#globel-dialog-div').dialog({
                title: '选择产品',
                iconCls: 'icons-application-application_add',
                width: 600,
                height: 540,
                cache: false,
                href: url,
                modal: true,
                collapsible: false,
                minimizable: false,
                resizable: false,
                maximizable: false,
                buttons: [{
                    text: '确定',
                    iconCls: 'icons-other-tick',
                    handler: function () {
                        $(that.dialog).find('form').eq(0).form('submit', {
                            onSubmit: function () {
                                var isValid = $(this).form('validate');
                                if (!isValid) return false;

                                var formArray = $(this).serializeArray();
                                var url = '__URL__/searchviewAddress/';
                                $.each(formArray, function (key, value) {
                                    url = url + value.name + '/' + value.value;
                                })
                                IndexIndexModule.openOperateTab(url, '订单地址查询');
                                $(that.dialog).dialog('close');
                                return false;
                            }
                        });
                    }
                }, {
                    text: '取消',
                    iconCls: 'icons-arrow-cross',
                    handler: function () {
                        $('#globel-dialog-div').dialog('close');
                    }
                }]
            });

        },

        /* 清空产品上的内容 */
        clearProducts: function (rowNum) {
            var productsCode = $("#{$moduleName}{$Think.ACTION_NAME|ucfirst}productsCode_" + rowNum).val();
            var productsName = $("#{$moduleName}{$Think.ACTION_NAME|ucfirst}productsName_" + rowNum).val();

            if ((productsCode == '') && (productsName == '')) {
                return;
            }
            if (confirm("是否要清空内容")) {
                $("#{$moduleName}{$Think.ACTION_NAME|ucfirst}productsNumber_" + rowNum).val('');
                $("#{$moduleName}{$Think.ACTION_NAME|ucfirst}productsCode_" + rowNum).val('');
                $("#{$moduleName}{$Think.ACTION_NAME|ucfirst}productsName_" + rowNum).val('');
                $("#{$moduleName}{$Think.ACTION_NAME|ucfirst}productsShortName_" + rowNum).val('');
                $("#{$moduleName}{$Think.ACTION_NAME|ucfirst}productsPrice_" + rowNum).val('');
                $("#{$moduleName}{$Think.ACTION_NAME|ucfirst}productsMoney_" + rowNum).val(0);
                this.sumProductsMoney(rowNum);
            }
        },

        /*  删除产品最后一行 */
        delProducts: function () {
            //取得表格行的长度
            var rowNum = $("#{$moduleName}{$Think.ACTION_NAME|ucfirst}productsTable tr").length;
            if (rowNum == 2) {
                alert("最后一行不能删除");
                return;
            }
            $("#{$moduleName}{$Think.ACTION_NAME|ucfirst}productsTable tr:last").remove();
            $("#{$moduleName}{$Think.ACTION_NAME|ucfirst}productsLength").attr("value", rowNum - 1);  //表格行数保存
            this.sumProductsMoney(rowNum);

        },



        //根据用户输入的产品代码，输出产品名称和价格
        getProducts: function (rowNum, code) {
            var that = this;
            $.ajax({
                url: APP + '/Products' + "/getProductsByCode&code=" + code,
                async: true,
                beforeSend: function () {
                },
                success: function (mydata) {
                    var productsName = '';
                    if (mydata) {
                        //首先检查父窗口表格是否有存在输入的代码和产品
                        var rowLength = $("#productsTable tr").length;
                        for (i = 1; i < rowLength; i++) {
                            productsName = $("{$moduleName}{$Think.ACTION_NAME|ucfirst}#productsName_" + i).val();
                            if ((productsName == mydata.name) && (i != rowNum)) {
                                alert('产品已经存在,不能添加！');
                                return;
                            }
                        }
                        $("#{$moduleName}{$Think.ACTION_NAME|ucfirst}productsName_" + rowNum).val(mydata.name);
                        $("#{$moduleName}{$Think.ACTION_NAME|ucfirst}productsShortName_" + rowNum).val(mydata.shortname);
                        $("#{$moduleName}{$Think.ACTION_NAME|ucfirst}productsPrice_" + rowNum).val(mydata.price);
                        //计算总的金额
                        that.sumProductsMoney(rowNum);
                        //跳转到下一行
                        var focusNum = rowNum + 1;
                        $("#{$moduleName}{$Think.ACTION_NAME|ucfirst}productsNumber_" + focusNum).focus();
                    } else {
                        alert("输入的产品代码有错误，请重新输入！");
                        return;
                    }
                }

            })
        },


        /* 计算产品金额 */
        sumProductsMoney: function (rowNum) {
            var productsNumber = $("#{$moduleName}{$Think.ACTION_NAME|ucfirst}productsNumber_" + rowNum).val();  //数量
            //如果没有输入产品数量,就为零
            if(productsNumber == '') {
                productsNumber = 0;
            }
            else{
                if (this.IsNum(productsNumber)  == false){
                   alert('输入的产品数量不对!请检查');
                   return false;
                }
            }
            var productsPrice = $("#{$moduleName}{$Think.ACTION_NAME|ucfirst}productsPrice_" + rowNum).val();  //单价
            var productsMoney = 0;
            productsMoney = parseInt(productsNumber) * parseFloat(productsPrice);

            //写入
            $("#{$moduleName}{$Think.ACTION_NAME|ucfirst}productsMoney_" + rowNum).val(productsMoney);
            //计算全部的金额
            var totalMoney = 0;
            var productsTotalNumber = 0;
            //取得表格行的长度
            var rowLength = $("#{$moduleName}{$Think.ACTION_NAME|ucfirst}productsTable tr").length;
            for (i = 1; i < rowLength; i++) {
                if ($("#{$moduleName}{$Think.ACTION_NAME|ucfirst}productsMoney_" + i).val() > 0) {
                    totalMoney = totalMoney + parseFloat($("#{$moduleName}{$Think.ACTION_NAME|ucfirst}productsMoney_" + i).val());
                }
                var productsNumberCount =   $("#{$moduleName}{$Think.ACTION_NAME|ucfirst}productsNumber_" + i).val();
                if(productsNumberCount == ''){
                    productsNumberCount = 0;
                }
                if (productsNumberCount > 0) {
                productsTotalNumber = productsTotalNumber + parseInt($("#{$moduleName}{$Think.ACTION_NAME|ucfirst}productsNumber_" + i).val());
                }
            }

            //写入总的金额
            //totalMoney = totalMoney.toFixed(2);
            $("#{$moduleName}{$Think.ACTION_NAME|ucfirst}productsTotalMoney").val(totalMoney);
            //下一个表格代码输入框显示焦点
            rowNum = rowNum + 0;
            //加上送餐费
            var shippingmoney = 0;
            var shippingmoneyVal = $('#{$moduleName}{$Think.ACTION_NAME|ucfirst}Form input[name=shippingmoney]').val();
            if (shippingmoneyVal) {
                shippingmoney = parseFloat(shippingmoneyVal);
            }
            totalMoney = totalMoney + shippingmoney;
            totalMoney = parseFloat(totalMoney).toFixed(2);
            $("#{$moduleName}{$Think.ACTION_NAME|ucfirst}FormTotalMoney").html(totalMoney+'元');  //订单总金额
            $("#{$moduleName}{$Think.ACTION_NAME|ucfirst}Form input[name=totalmoney]").val(totalMoney);
            $("#{$moduleName}{$Think.ACTION_NAME|ucfirst}FormShouldMoney").html(totalMoney+'元');    //应收金额
            $("#{$moduleName}{$Think.ACTION_NAME|ucfirst}Form input[name=shouldmoney]").val(totalMoney);
            $('#productsTotalNumber').html(productsTotalNumber + '份');
        },


        //产品代码失去焦点的计算金额
        blurSumProductsMoney: function (rowNum, obj) {
            if ($("#{$moduleName}{$Think.ACTION_NAME|ucfirst}productsName_" + rowNum).val() != '') {    //如果不为空，才计算
                sumProductsMoney(rowNum);
            }
        },

        //把产品价格单元设置为可改写
        setGoodsPrice : function(row){
            $("#{$moduleName}{$Think.ACTION_NAME|ucfirst}productsPrice_" + row).attr('readonly',false);
        },


        //判断是否为数字
        IsNum :function (s)
        {
            if (s!=null && s!="")
            {
             return !isNaN(s);
            }
        return false;
        }

    }

    /*产品的js计算程序*/
    var productsAjax = false;  //判断是否查询过产品代码，防止在ajax中按回车，反复执行，有个alert的小bug


</script>
